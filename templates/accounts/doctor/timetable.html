{% extends 'base.html' %}
{% load utils %}
{% block breadcrumbs %}
    <a href="{% url 'profile' pk=doctor.user.id %}" class="breadcrumb">Doctor profile</a>
    {#    TODO timetable breadcrumb#}
{% endblock %}

{% block content %}
    <div class="container">
        {% for shift_type in shift_types %}
            <div class="shift-type">
                <div class="shift-type-header">
                    <h4> Смена {{ shift_type.start|date:"H:i" }} - {{ shift_type.end|date:"H:i" }},
                        время приема {{ shift_type.gap.seconds|divide_no_remainder:60 }} минут</h4>
                </div>
                <div class="timetable">
                    <div class="time">
                        {% for gap in shift_type.visit_gaps %}

                            {% if forloop.counter0 == 0 %}
                                <div class="timetable-cell">
                                </div>
                            {% endif %}
                            <div class="timetable-cell">
                                {{ gap.0|date:"H:i" }} - {{ gap.1|date:"H:i" }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="shifts">
                        {% for shift in shift_type.shift_set.all %}
                            <div class="shift">
                                {% for gap_visit in shift.timetable_visits %}
                                    {% if forloop.counter0 == 0 %}
                                        <div class="timetable-cell">
                                            <div class="date-header">{{ shift.day|date:"m-d" }}</div>
                                        </div>
                                    {% endif %}
                                    {% if gap_visit.id %}
                                        <div class="timetable-cell {% if gap_visit.patient == user.patient %} owner{% endif %}"
                                                {% if gap_visit.patient == user.patient %}
                                             data-start="{{ gap_visit.start|time:"H:i" }}"
                                             data-end="{{ gap_visit.end|time:"H:i" }}"
                                             data-shift="{{ shift.id }}"
                                             data-visit-id="{{ gap_visit.id }}"
                                                {% endif %}>

                                        </div>
                                    {% elif gap_visit %}
                                        <div class="timetable-cell free"
                                             data-start="{{ gap_visit.0|time:"H:i" }}"
                                             data-end="{{ gap_visit.1|time:"H:i" }}"
                                             data-shift="{{ shift.id }}">
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <button class="btn beige visit-create beige" style="display: none"></button>
                <button class="btn beige visit-remove beige" style="display: none"></button>
            </div>
        {% endfor %}
    </div>
{% endblock %}
{% block extrajs %}
    <script>
        $(document).ready(function () {
            $(document).on('click', '.free', function () {
                var el = $(this);
                var btn = el.parents('.shift-type').find('.visit-create');
                if (!el.hasClass('active')) {
                    $('.free.active').removeClass('active');
                    btn.show();
                    btn.data(el.data());
                    btn.html('Записаться на прием на ' + el.data('start') + '-' + el.data('end'))
                }
                else {
                    btn.hide();
                    btn.data('')
                }
                el.toggleClass('active');
            });
            $(document).on('click', '.owner', function () {
                var el = $(this);
                var btn = el.parents('.shift-type').find('.visit-remove');
                if (!el.hasClass('active')) {
                    $('.owner.active').removeClass('active');
                    btn.show();
                    btn.data(el.data());
                    btn.html('Отменить запись на ' + el.data('start') + '-' + el.data('end'))
                }
                else {
                    btn.hide();
                    btn.data('')
                }
                el.toggleClass('active');
            });
            $('.visit-create').on('click', function () {
                var el = $(this);
                $.ajax({
                    method: "POST",
                    url: "{% url 'visit-create' %}",
                    data: {
                        'start': el.data('start') + ':00',
                        'end': el.data('end') + ':00',
                        'shift': el.data('shift')
                    },
                    success: function (response) {
                        data = response;
                        if (data.success) {
                            $('.free.active').removeClass('free active').addClass('owner').data('visit-id', data.visit_id)
                            el.hide()
                        }
                        else {
                            console.log(response)
                        }
                    }
                })
            });
            remove_url = "{% url 'visit-remove' pk=0 %}";
            $('.visit-remove').on('click', function () {
                el = $(this);
                $.ajax({
                    method: "POST",
                    url: remove_url.replace(0, el.data('visit-id')),
                    success: function (response) {
                        data = response;
                        if (data.success) {
                            $('.owner.active').removeClass('owner active').addClass('free').data('visit-id', null);
                            el.hide()
                        }
                    }
                })
            })
        })
    </script>
{% endblock %}